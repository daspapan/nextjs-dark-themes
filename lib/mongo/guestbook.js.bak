import clientPromise from "./client";

let client
let db
let guestbook

async function init(){
    if(db) return

    try{
        client = await clientPromise
        db = client.db()
        guestbook = await db.collection("guestbook")
    }catch(error){
        throw new Error("Could not connect to the database.")
    }
}

;(async () => {
    await init()
})()



export const getGuestbookEntries = async () => {
    try{

        if(!guestbook) await init()

        console.log('Fetching entries...')

        const entries = await guestbook
            .find({})
            .map(entry => ({...entry, _id: entry._id.toString()}))
            .toArray()
        
        return {entries}

    }catch(error){
        throw new Error("Failed to fetch guestbook.")
    }
}

export const createGuestbookEntry = async ({name, message}) => {
    try {

        if(!guestbook) await init()

        return await guestbook.insertOne({name, message, updateAt: new Date()})

    }catch(error){
        throw new Error("Failed to create guestbook entry.")
    }
}